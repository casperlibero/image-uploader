<!DOCTYPE html>
<html lang="pt-Br">
<head>
    <meta charset="utf-8">
    <title>Upload de imagens em HTML5 - Protótipo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le styles -->
    <link href="assets/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
    body {
        padding-top: 20px;
        padding-bottom: 60px;
    }

    /* Custom container */
    .container {
        margin: 0 auto;
        max-width: 1000px;
    }
    .container > hr {
        margin: 30px 0;
    }

    /* Main marketing message and sign up button */
    .jumbotron {
        margin: 80px 0;
        text-align: center;
    }
    .jumbotron h1 {
        font-size: 100px;
        line-height: 1;
    }

    /* Uploader: Drag & Drop */
    .resumable-error {
        display: none;
    }

    .resumable-drop {
        padding: 15px;
        font-size: 13px;
        text-align: center;
        color: #666;
        font-weight: bold;
        background-color: #eee;
        border: 2px dashed #aaa;
        border-radius: 10px;
        margin-top: 40px;
        z-index: 9999;
        display: none;
    }

    /* Uploader: Progress bar */
    .resumable-progress {margin:30px 0 30px 0; width:100%; display:none;}
    /*.progress-container {height:7px; background:#9CBD94; position:relative; }*/
    /*.progress-bar {position:absolute; top:0; left:0; bottom:0; background:#45913A; width:0;}*/
    .progress-text {font-size:11px; line-height:9px; padding-left:10px;}
    /*.progress-pause {padding:0 0 0 7px;}*/
    .progress-resume-link {display:none;}
    .is-paused .progress-resume-link {display:inline;}
    .is-paused .progress-pause-link {display:none;}
    .is-complete .progress-pause {display:none;}

    /* Uploader: List of items being uploaded */
    .resumable-table {display:none;}
    /*
    .resumable-list {overflow:auto; margin-right:-20px; display:none;}
    .uploader-item {width:148px; height:90px; background-color:#666; position:relative; border:2px solid black; float:left; margin:0 6px 6px 0;}
    .uploader-item-thumbnail {width:100%; height:100%; position:absolute; top:0; left:0;}
    .uploader-item img.uploader-item-thumbnail {opacity:0;}
    .uploader-item-creating-thumbnail {padding:0 5px; font-size:9px; color:white;}
    .uploader-item-title {position:absolute; font-size:9px; line-height:11px; padding:3px 50px 3px 5px; bottom:0; left:0; right:0; color:white; background-color:rgba(0,0,0,0.6); min-height:27px;}
    .uploader-item-status {position:absolute; bottom:3px; right:3px;}
    */

    /* sprites - browser support */
    .browsers a {
        background-image: url("assets/img/icon-browser-72x72.png");
        border-bottom-style: none;
        display: block;
        height: 72px;
        text-indent: -9999px;
        width: 72px;
    }

    .browsers a.Chrome {
        background-position: 0 0;
    }

    .browsers a.Firefox {
        background-position: 0 -72px;
    }

    .browsers a.Internet_Explorer {
        background-position: 0 -144px;
    }

    .browsers a.Opera {
        background-position: 0 -216px;
    }

    .browsers a.Safari {
        background-position: 0 -288px;
    }

    </style>
    <link href="assets/css/bootstrap-responsive.css" rel="stylesheet">
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="assets/js/html5shiv.js"></script>
    <![endif]-->
</head>

<body>
    <div class="container">

        <div class="row-fluid">
            <div class="span12">
                <h2 class="muted text-center">Protótipo</h2>
                <h3 class="muted text-center">Upload de imagens</h3>
            </div>
        </div><!-- /.row-fluid -->

        <div class="row-fluid resumable-error">
            <div class="span12 well">
                <h3>Navegador incompatível</h3>
                <p>Seu navegador, infelizmente, não suporta esse tipo de upload.</p>
                <p>Utilize a versão mais recente de um dos seguintes navegadores: </p>
                <ul class="browsers unstyled inline">
                    <li><a title="Chrome" href="http://www.google.com/intl/pt-BR/chrome/browser/" class="Chrome">Chrome</a></li>
                    <li><a title="Firefox" href="http://www.mozilla.org/pt-BR/firefox/fx/" class="Firefox">Firefox</a></li>
                    <li><a title="Opera" href="http://www.opera.com/pt/download" class="Opera">Opera</a></li>
                    <li><a title="Internet Explorer 10" href="http://windows.microsoft.com/pt-br/internet-explorer/downloads/ie-10/worldwide-languages" class="Internet_Explorer">Internet Explorer</a></li>
                </ul>
            </div>
        </div>

        <div class="row-fluid">
            <div class="span12">
                <div class="resumable-drop" ondragenter="jQuery(this).addClass('resumable-dragover');" ondragend="jQuery(this).removeClass('resumable-dragover');" ondrop="jQuery(this).removeClass('resumable-dragover');">
                    <h3>Arraste arquivos aqui ou <a class="resumable-browse"><u>selecione de seu computador</u></a></h3>
                </div>
            </div>
        </div>

        <div class="resumable-progress">
            <div class="row-fluid">
                <div class="span12">
                    <div class="progress progress-info progress-striped active">
                        <div class="bar"></div>
                    </div>
                    <!--
                    <table>
                        <tr>
                            <td width="100%">
                                <div class="progress progress-info progress-striped active">
                                    <div class="bar"></div>
                                </div>
                            </td>
                            <td class="progress-text" nowrap="nowrap"></td>
                            <td class="progress-pause" nowrap="nowrap">
                                <a href="#" onclick="r.upload(); return(false);" class="progress-resume-link">
                                    <img src="assets/img/resume.png" title="Resume upload" />
                                </a>
                                <a href="#" onclick="r.pause(); return(false);" class="progress-pause-link">
                                    <img src="assets/img/pause.png" title="Pause upload" />
                                </a>
                            </td>
                        </tr>
                    </table>
                    -->
                </div>
            </div>
            
            <div class="row-fluid">
                <div class="span12">
                    <a href="#" onclick="r.upload(); return(false);" class="progress-resume-link">
                        <img src="assets/img/resume3.png" title="Continuar upload" />
                    </a>
                    <a href="#" onclick="r.pause(); return(false);" class="progress-pause-link">
                        <img src="assets/img/pause3.png" title="Pausar upload" />
                    </a>
                </div>
            </div>

        </div>

        <div class="row-fluid">
            <div class="span12">
                <!--<ul class="resumable-list"></ul>-->

                <table class="table table-striped table-bordered resumable-table">
                <thead>
                    <tr>
                        <th>Arquivo</th>
                        <th>Tamanho</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
                </table>
            </div>
        </div><!-- /.row-fluid -->

        <hr>

        <div class="footer">
            <p>Protótipo - Upload em HTML5</p>
        </div>

    </div> <!-- /.container -->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="assets/js/resumable.js"></script>
    <script>
    var r = new Resumable({
        target: '../src/upload.php',
        chunkSize: 1*1024*1024,
        simultaneousUploads: 4,
        testChunks: false,
        throttleProgressCallbacks: 1
    });

    // Resumable.js isn't supported, fall back on a different method
    if (!r.support) {
        $('.resumable-error').show();
    } else {
        // Show a place for dropping/selecting files
        $('.resumable-drop').show();
        r.assignDrop($('.resumable-drop')[0]);
        r.assignBrowse($('.resumable-browse')[0]);

        // Handle file add event
        r.on('fileAdded', function(file){
            $('.progress').removeClass('progress-success').addClass('progress-info progress-striped active');
            $('.progress > .bar').empty();

            // Show progress pabr
            //$('.resumable-progress, .resumable-list').show();
            $('.resumable-progress, .resumable-table').show();
            // Show pause, hide resume
            $('.resumable-progress .progress-resume-link').hide();
            $('.resumable-progress .progress-pause-link').show();
            // Add the file to the list
            $('.resumable-list').append('<li class="resumable-file-'+file.uniqueIdentifier+'">Uploading <span class="resumable-file-name"></span> <span class="resumable-file-progress"></span>');

            var new_file = '<tr class="resumable-file-'+file.uniqueIdentifier+'"><td class="resumable-file-name"></td><td class="resumable-file-size"></td><td class="resumable-file-progress"></td></tr>';

            $('.resumable-table > tbody').append(new_file);

            $('.resumable-file-'+file.uniqueIdentifier+' .resumable-file-name').html(file.fileName);

            //var file_size_mb = file.size / 1024 / 1024;
            $('.resumable-file-'+file.uniqueIdentifier+' .resumable-file-size').html(bytesToSize(file.size));
            // Actually start the upload
            r.upload();
        });

        r.on('pause', function(){
            // Show resume, hide pause
            $('.resumable-progress .progress-resume-link').show();
            $('.resumable-progress .progress-pause-link').hide();
        });

        r.on('upload', function(){
            $('.resumable-progress .progress-resume-link').hide();
            $('.resumable-progress .progress-pause-link').show();
        });

        r.on('complete', function(){
            // Hide pause/resume when the upload has completed
            $('.resumable-progress .progress-resume-link, .resumable-progress .progress-pause-link').hide();
            $('.progress').removeClass('progress-info progress-striped active').addClass('progress-success');
            $('.progress > .bar').text('Upload completo');
        });

        r.on('fileSuccess', function(file, message){
            // Reflect that the file upload has completed
            //$('.resumable-file-'+file.uniqueIdentifier+' .resumable-file-progress').html('(completed)');
            $('.resumable-file-'+file.uniqueIdentifier+' .resumable-file-progress').html('<span class="label label-success">Completo</span>');

            var thumbnail = createThumbnail(file.file, function(data){
                //console.log(data);
                $('.resumable-file-'+file.uniqueIdentifier+' .resumable-file-name').append(' <img alt="teste" src="' + data + '">');
            });
        });

        r.on('fileError', function(file, message){
            // Reflect that the file upload has resulted in error
            
            //$('.resumable-file-'+file.uniqueIdentifier+' .resumable-file-progress').html('(file could not be uploaded: '+message+')');
            $('.resumable-file-'+file.uniqueIdentifier+' .resumable-file-progress').html('<span class="label label-important">'+message+'</span>');
        });

        r.on('fileProgress', function(file){
            // Handle progress for both the file and the overall upload
            $('.resumable-file-'+file.uniqueIdentifier+' .resumable-file-progress').html(Math.floor(file.progress()*100) + '%');
            //$('.progress-bar').css({width:Math.floor(r.progress()*100) + '%'});
            var upload_progress = Math.floor(r.progress()*100) + '%';
            $('.progress > .bar').css({width:upload_progress}).text(upload_progress);
        });
    }

    function createThumbnail(file, callback) {

      var fileReader;

      fileReader = new FileReader;
      fileReader.onload = function() {
        var img;

        img = new Image;
        img.onload = function() {
          var canvas, ctx, srcHeight, srcRatio, srcWidth, srcX, srcY, thumbnail, trgHeight, trgRatio, trgWidth, trgX, trgY;

          canvas = document.createElement("canvas");
          ctx = canvas.getContext("2d");
          srcX = 0;
          srcY = 0;
          srcWidth = img.width;
          srcHeight = img.height;
          canvas.width = 100;
          canvas.height = 100;
          trgX = 0;
          trgY = 0;
          trgWidth = canvas.width;
          trgHeight = canvas.height;
          srcRatio = img.width / img.height;
          trgRatio = canvas.width / canvas.height;
          if (img.height < canvas.height || img.width < canvas.width) {
            trgHeight = srcHeight;
            trgWidth = srcWidth;
          } else {
            if (srcRatio > trgRatio) {
              srcHeight = img.height;
              srcWidth = srcHeight * trgRatio;
            } else {
              srcWidth = img.width;
              srcHeight = srcWidth / trgRatio;
            }
          }
          srcX = (img.width - srcWidth) / 2;
          srcY = (img.height - srcHeight) / 2;
          trgY = (canvas.height - trgHeight) / 2;
          trgX = (canvas.width - trgWidth) / 2;
          ctx.drawImage(img, srcX, srcY, srcWidth, srcHeight, trgX, trgY, trgWidth, trgHeight);
          thumbnail = canvas.toDataURL("image/png");

            return callback(thumbnail);
        };
        return img.src = fileReader.result;
      };
      return fileReader.readAsDataURL(file);
    };

    function bytesToSize(bytes) {
        var sizes = ['desconhecido', 'bytes', 'KB', 'MB', 'GB'];
        var i = +Math.floor(Math.log(bytes) / Math.log(1024));
        return (bytes / Math.pow(1024, i)).toFixed( i ? 1 : 0 ) + ' ' + sizes[ isNaN( bytes ) ? 0 : i+1 ];
    }
    </script>

</body>
</html>
