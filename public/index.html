<!DOCTYPE html>
<html lang="pt-Br">
<head>
    <meta charset="utf-8">
    <title>Upload de imagens em HTML5 - Protótipo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le styles -->
    <link href="assets/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
    body {
        padding-top: 20px;
        padding-bottom: 60px;
    }

    /* Custom container */
    .container {
        margin: 0 auto;
        max-width: 1000px;
    }
    .container > hr {
        margin: 30px 0;
    }

    /* Uploader: Drag & Drop */
    .resumable-error {
        display: none;
    }

    .resumable-drop {
        padding: 15px;
        font-size: 13px;
        text-align: center;
        color: #666;
        font-weight: bold;
        background-color: #eee;
        border: 2px dashed #aaa;
        border-radius: 10px;
        margin-top: 40px;
        z-index: 9999;
        display: none;
    }

    /* Uploader: Progress bar */
    .progress-text {
        font-size: 11px;
        line-height: 9px;
        padding-left: 10px;
    }
    .resume-pause, .progress-resume-link, .progress-pause-link {
        display: none;
    }

    .resumable-progress {
        margin-top: 15px;
        display: none;
    }

    /* Uploader: List of items being uploaded */
    .resumable-table {
        display: none;
        margin-top: 15px;
    }

    /* sprites - browser support */
    .browsers a {
        background-image: url("assets/img/icon-browser-72x72.png");
        border-bottom-style: none;
        display: block;
        height: 72px;
        text-indent: -9999px;
        width: 72px;
    }

    .browsers a.Chrome {
        background-position: 0 0;
    }

    .browsers a.Firefox {
        background-position: 0 -72px;
    }

    .browsers a.Internet_Explorer {
        background-position: 0 -144px;
    }

    .browsers a.Opera {
        background-position: 0 -216px;
    }

    .browsers a.Safari {
        background-position: 0 -288px;
    }

    </style>
    <link href="assets/css/bootstrap-responsive.css" rel="stylesheet">
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="assets/js/html5shiv.js"></script>
    <![endif]-->
</head>

<body>
    <div class="container">

        <div class="row-fluid">
            <div class="span12">
                <h2 class="muted text-center">Protótipo</h2>
                <h3 class="muted text-center">Upload de imagens</h3>
            </div>
        </div><!-- /.row-fluid -->

        <div class="row-fluid resumable-error">
            <div class="span12 well">
                <h3>Navegador incompatível</h3>
                <p>Seu navegador, infelizmente, não suporta esse tipo de upload.</p>
                <p>Utilize a versão mais recente de um dos seguintes navegadores: </p>
                <ul class="browsers unstyled inline">
                    <li><a title="Chrome" href="http://www.google.com/intl/pt-BR/chrome/browser/" class="Chrome">Chrome</a></li>
                    <li><a title="Firefox" href="http://www.mozilla.org/pt-BR/firefox/fx/" class="Firefox">Firefox</a></li>
                    <li><a title="Opera" href="http://www.opera.com/pt/download" class="Opera">Opera</a></li>
                    <li><a title="Internet Explorer 10" href="http://windows.microsoft.com/pt-br/internet-explorer/downloads/ie-10/worldwide-languages" class="Internet_Explorer">Internet Explorer</a></li>
                </ul>
            </div>
        </div>

        <div class="row-fluid">
            <div class="span12">
                <div class="resumable-drop" ondragenter="jQuery(this).addClass('resumable-dragover');" ondragend="jQuery(this).removeClass('resumable-dragover');" ondrop="jQuery(this).removeClass('resumable-dragover');">
                    <h3>Arraste arquivos aqui ou <a class="resumable-browse"><u>selecione de seu computador</u></a></h3>
                </div>
            </div>
        </div>

        <div class="resumable-progress">
            <div class="row-fluid">
                <div class="span12">
                    <a href="#" onclick="r.upload(); return(false);" class="progress-resume-link">
                        <img src="assets/img/resume3.png" title="Continuar upload" />
                    </a>
                    <a href="#" onclick="r.pause(); return(false);" class="progress-pause-link">
                        <img src="assets/img/pause3.png" title="Pausar upload" />
                    </a>
                </div>
            </div>
        </div>

        <div class="row-fluid">
            <div class="span12">
                <table class="table table-striped table-bordered resumable-table">
                <thead>
                    <tr>
                        <th>Arquivo</th>
                        <th>Tamanho</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
                </table>
            </div>
        </div><!-- /.row-fluid -->

        <hr>

        <div class="footer">
            <p>Protótipo - Upload em HTML5</p>
        </div>

    </div> <!-- /.container -->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="assets/js/resumable.js"></script>
    <script>
    // instância da biblioteca Resumable
    var r = new Resumable({
        target: '../src/upload.php', // destino server-side que irá receber os arquivos
        chunkSize: 1024 * 1024, // O tamanho de cada parte do arquivo
        simultaneousUploads: 4, // quantidade de uploads simultâneos
        testChunks: false, // usa o método POST, não sendo possível resumir o upload em cada de crash no browser eu restart do computador
        fileType: ['jpeg'], // tipos de arquivos permitidos para upload
        maxChunkRetries: 30, // quantidade de vezes que tenta reupar por algum problema de conexão
        chunkRetryInterval: 60000 * 2 // intervalo de tempo entre cada tentativa de reupload (em milisegundos. 1000 milisegundos = 1 segundo)
    });

    // fall back (sem suporte HTML5 File API)
    if (!r.support) {
        $('.resumable-error').show();
    } else {
        $('.resumable-drop').show();
        r.assignDrop($('.resumable-drop')[0]);
        r.assignBrowse($('.resumable-browse')[0]);

        // Evento para cada arquivo adicionado
        r.on('fileAdded', function(file) {
            // Adiciona info do arquivo na tabela html
            $('.resumable-list').append('<li class="resumable-file-'+file.uniqueIdentifier+'">Uploading <span class="resumable-file-name"></span> <span class="resumable-file-progress"></span>');

            var new_file = '<tr class="resumable-file-'+file.uniqueIdentifier+'"><td class="resumable-file-name"></td><td class="resumable-file-size"></td><td class="resumable-file-progress"></td></tr>';

            $('.resumable-table > tbody').append(new_file);
            createThumbnail(file.file, function(data) {
                if (data) {
                    $('.resumable-file-'+file.uniqueIdentifier+' .resumable-file-name').prepend('<img alt="'+file.fileName+'" title="'+file.fileName+'" src="' + data + '"> ');
                }
            });
            $('.resumable-file-'+file.uniqueIdentifier+' .resumable-file-name').html(file.fileName);
            $('.resumable-file-'+file.uniqueIdentifier+' .resumable-file-size').html(bytesToSize(file.size));
            // Inicia o upload
            r.upload();
        });

        // Evento quando o upload é pausado
        r.on('pause', function(){
            $('.resumable-progress .progress-resume-link').show();
            $('.resumable-progress .progress-pause-link').hide();
        });

        // Evento do upload em progresso
        r.on('progress', function(){
            $('.resumable-table, .resumable-progress').show();

            $('.resumable-progress .progress-resume-link').hide();
            $('.resumable-progress .progress-pause-link').show();
        });

        // Evento de cada arquivo em progresso
        r.on('fileProgress', function(file) {
            var upload_progress = Math.floor(r.progress()*100);
            $('.resumable-file-'+file.uniqueIdentifier+' .resumable-file-progress').html('<span class="badge badge-warning">'+upload_progress+'%</span>');
        });

        // Evento para qualquer erro com o upload
        r.on('error', function(message, file) {
            $('.resumable-file-'+file.uniqueIdentifier+' .resumable-file-progress').html('<span class="label label-important">'+message+'</span>');

            $('.resumable-progress .progress-resume-link').hide();
            $('.resumable-progress .progress-pause-link').hide();
        });

        // Evento para o upload do arquivo com sucesso
        r.on('fileSuccess', function(file, message) {
            $('.resumable-file-'+file.uniqueIdentifier+' .resumable-file-progress').html('<span class="badge badge-success">100%</span>');
        });

        // Evento para quando termina o upload, com sucesso ou não
        r.on('complete', function() {
            $('.resumable-progress .progress-resume-link, .resumable-progress .progress-pause-link').hide();
        });
    }

    // função que cria thumbnail para os arquivos
    function createThumbnail(file, callback) {
        // somente cria o thumbnail para arquivos de imagem
        if (file.type.split('/')[0] != 'image') return false;

        var fileReader;

        fileReader = new FileReader;
        fileReader.onload = function() {
            var img;

            img = new Image;
            img.onload = function() {
                var canvas, ctx, srcHeight, srcRatio, srcWidth, srcX, srcY, thumbnail, trgHeight, trgRatio, trgWidth, trgX, trgY;

                canvas = document.createElement("canvas");
                ctx = canvas.getContext("2d");
                srcX = 0;
                srcY = 0;
                srcWidth = img.width;
                srcHeight = img.height;
                canvas.width = 100;
                canvas.height = 100;
                trgX = 0;
                trgY = 0;
                trgWidth = canvas.width;
                trgHeight = canvas.height;
                srcRatio = img.width / img.height;
                trgRatio = canvas.width / canvas.height;
                if (img.height < canvas.height || img.width < canvas.width) {
                    trgHeight = srcHeight;
                    trgWidth = srcWidth;
                } else {
                    if (srcRatio > trgRatio) {
                        srcHeight = img.height;
                        srcWidth = srcHeight * trgRatio;
                    } else {
                        srcWidth = img.width;
                        srcHeight = srcWidth / trgRatio;
                    }
                }
                srcX = (img.width - srcWidth) / 2;
                srcY = (img.height - srcHeight) / 2;
                trgY = (canvas.height - trgHeight) / 2;
                trgX = (canvas.width - trgWidth) / 2;
                ctx.drawImage(img, srcX, srcY, srcWidth, srcHeight, trgX, trgY, trgWidth, trgHeight);
                thumbnail = canvas.toDataURL("image/png");

                return callback(thumbnail);
            };

            return img.src = fileReader.result;
        };

        return fileReader.readAsDataURL(file);
    };

    // função que retorna o tamanho dos arquivos para uma leitura humana
    function bytesToSize(bytes) {
        var sizes = ['desconhecido', 'bytes', 'KB', 'MB', 'GB'];
        var i = +Math.floor(Math.log(bytes) / Math.log(1024));
        return (bytes / Math.pow(1024, i)).toFixed( i ? 1 : 0 ) + ' ' + sizes[ isNaN( bytes ) ? 0 : i+1 ];
    }
    </script>

</body>
</html>
